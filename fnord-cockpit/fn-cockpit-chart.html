<!--
  This file is part of the "FnordMetric" project
    Copyright (c) 2014 Laura Schlimmer
    Copyright (c) 2014 Paul Asmuth, Google Inc.

  FnordMetric is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License v3.0. You should have received a
  copy of the GNU General Public License along with this program. If not, see
  <http://www.gnu.org/licenses/>.
  only if attribute future-selectable is set future dates are selectable
  same holds true for past-selectable
-->
<template id='fn-cockpit-chart-base-tpl'>
  <div class="chart"></div>
</template>
<script type='text/javascript'>
  var CockpitChartComponent = function() {
    this.createdCallback = function() {
      var tpl = Fnord.getTemplate("fn-cockpit-chart", "base");
      var shadow = this.createShadowRoot();
      shadow.appendChild(tpl);

      if (this.hasAttribute('data-width')) {
        this.setWidth();
      }

      if (this.hasAttribute('data-url')) {
        this.render();
      }
    };

    this.attributeChangedCallback = function(attr, old_val, new_Val) {
      if (attr == 'data-url') {
        this.render();
      }
    };

    this.setWidth = function() {
      var url = this.getAttribute('data-url');
      var base = this;

      if (this.hasAttribute('data-width')) {
        var size = this.getAttribute('data-width');
        if (size[size.length - 1] == "%") {
          var val = parseInt(size.substr(0, size.length -1), 10);

          url = url.replace(
            "%%width%%",  Math.round(this.parentNode.offsetWidth * (val / 100)));
          this.setAttribute('data-url', url);
        }
      }
    };

    this.render = function() {
      var base = this;
      var chart = this.shadowRoot.querySelector(".chart");
      var url = this.getAttribute('data-url');

      if (url) {
        Fnord.httpGet(url, function(r) {
          if (r.status == 200) {
            chart.innerHTML = r.response;
            base.fireDataLoadedEvent({"status" : 200});
          } else {
            base.fireDataLoadedEvent({"status" : r.status});
          }
        });
      }
    };

    this.updateUrl = function(key, value) {
      this.getAttribute("url");
      var regex = new RegExp(key + '=.+&');
      var param = key + "=" + value + "&";
      this.setAttribute('url', url.replace(regex, param));
    };

    this.fireDataLoadedEvent = function(detail) {
      var loadedEvent = new CustomEvent(
        'fn-cockpit-chart-data-loaded', {
          "detail": detail,
          bubbles: true,
          cancelable: true
        }
      );

      this.dispatchEvent(loadedEvent);
    }
  };

  window.addEventListener('fn-ready', function() {
    Fnord.registerComponent('fn-cockpit-chart', CockpitChartComponent);
  }, false);
</script>
